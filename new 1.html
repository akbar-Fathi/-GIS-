<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ—ºï¸ Ø³ÛŒØ³ØªÙ… GIS Ø®Ø±Ù…â€ŒØ¢Ø¨Ø§Ø¯ â€” Ø§Ú©Ø¨Ø± ÙØªØ­ÛŒâ€ŒÙ¾ÙˆØ±</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Leaflet Draw -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    * { 
      box-sizing: border-box; 
      font-family: 'Tahoma', 'Segoe UI', sans-serif; 
    }
    
    html, body { 
      height: 100%; 
      margin: 0; 
      background: #0f172a; 
      color: #e6eef8; 
      overflow: hidden;
    }
    
    .container {
      display: grid;
      grid-template-columns: 450px 1fr;
      grid-template-rows: 70px 1fr 220px;
      gap: 12px;
      height: 100vh;
      padding: 12px;
    }
    
    .header {
      grid-column: 1 / 3;
      background: linear-gradient(90deg, #2563eb, #0ea5a9);
      border-radius: 8px;
      padding: 12px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 6px 18px rgba(2, 6, 23, 0.6);
      z-index: 1000;
    }
    
    .header h1 { 
      font-size: 1.2rem; 
      margin: 0; 
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .header .designer {
      font-size: 0.9rem;
      opacity: 0.9;
    }
    
    .header-controls {
      display: flex;
      gap: 10px;
    }
    
    .header-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
      font-size: 0.9rem;
    }
    
    .header-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }
    
    .header-btn.active {
      background: rgba(255, 255, 255, 0.4);
      box-shadow: 0 0 0 2px white;
    }
    
    .sidebar {
      background: #0b1220;
      border-radius: 8px;
      padding: 14px;
      overflow: auto;
      box-shadow: 0 6px 18px rgba(2, 6, 23, 0.6);
      z-index: 1000;
    }
    
    .panel { 
      background: #071028; 
      padding: 12px; 
      border-radius: 8px; 
      margin-bottom: 12px; 
    }
    
    .panel h3 {
      margin-top: 0;
      display: flex;
      align-items: center;
      gap: 8px;
      color: #f1f5f9;
      font-size: 1rem;
    }
    
    .upload-area {
      border: 2px dashed #f59e0b;
      border-radius: 10px;
      padding: 22px;
      text-align: center;
      cursor: pointer;
      color: #f1f5f9;
      transition: all 0.2s ease;
    }
    
    .upload-area:hover, .upload-area.drag { 
      background: rgba(245, 158, 11, 0.07); 
      transform: translateY(-2px);
    }
    
    .btn {
      background: #2563eb; 
      color: white; 
      border: none; 
      padding: 10px 12px; 
      border-radius: 8px;
      cursor: pointer; 
      width: 100%; 
      margin-top: 10px; 
      font-weight: 600;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 0.9rem;
    }
    
    .btn:hover {
      background: #1d4ed8;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3);
    }
    
    .btn-outline { 
      background: transparent; 
      border: 1px solid #94a3b8; 
      color: #e6eef8; 
    }
    
    .btn-outline:hover {
      background: rgba(148, 163, 184, 0.1);
      border-color: #cbd5e1;
    }
    
    .btn-danger { 
      background: #dc2626; 
    }
    
    .btn-danger:hover {
      background: #b91c1c;
    }
    
    .btn-success {
      background: #16a34a;
    }
    
    .btn-success:hover {
      background: #15803d;
    }
    
    .btn-warning {
      background: #d97706;
    }
    
    .btn-warning:hover {
      background: #b45309;
    }
    
    .btn-row { 
      display: flex; 
      gap: 8px; 
      margin-top: 10px; 
    }
    
    .btn-row .btn {
      margin-top: 0;
    }
    
    #map { 
      width: 100%; 
      height: 100%; 
      border-radius: 8px; 
      overflow: hidden; 
      box-shadow: 0 6px 18px rgba(2, 6, 23, 0.6);
    }

    .table-container {
      grid-column: 1 / 3;
      background: #071028;
      border-radius: 8px;
      padding: 12px;
      overflow: auto;
      direction: rtl;
      box-shadow: 0 6px 18px rgba(2, 6, 23, 0.6);
      z-index: 1000;
    }
    
    .table-container h3 {
      margin-top: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    table {
      width: 100%; 
      border-collapse: collapse; 
      color: #e6eef8; 
      font-size: 0.9rem;
    }
    
    th, td { 
      padding: 8px 10px; 
      border: 1px solid #0f172a; 
      text-align: center; 
    }
    
    th { 
      background: #0ea5a9; 
      color: #012; 
      font-weight: 700; 
    }
    
    tr:nth-child(even) { 
      background: #071a2a; 
    }
    
    tr:hover {
      background: rgba(37, 99, 235, 0.1);
    }

    .loading {
      position: absolute; 
      inset: 0; 
      display: none; 
      align-items: center; 
      justify-content: center;
      background: rgba(2, 6, 23, 0.8); 
      z-index: 9999;
      border-radius: 8px;
    }
    
    .spinner {
      width: 60px; 
      height: 60px; 
      border-radius: 50%; 
      border: 5px solid #0f172a; 
      border-top: 5px solid #f59e0b;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin { 
      to { 
        transform: rotate(360deg); 
      } 
    }

    /* Footer / signature */
    .signature {
      position: absolute;
      right: 14px;
      bottom: 14px;
      background: rgba(2, 6, 23, 0.8);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 0.95rem;
      display: flex; 
      gap: 8px; 
      align-items: center;
      backdrop-filter: blur(4px);
      z-index: 1000;
    }

    /* Mouse coordinates and scale */
    .map-info {
      position: absolute;
      bottom: 14px;
      left: 14px;
      background: rgba(2, 6, 23, 0.8);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 0.85rem;
      backdrop-filter: blur(4px);
      z-index: 1000;
      min-width: 200px;
    }
    
    .coord-display {
      font-family: monospace;
      margin-bottom: 4px;
    }
    
    .scale-display {
      font-family: monospace;
      color: #94a3b8;
    }

    /* Help panel */
    .help-toggle { 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      cursor: pointer; 
      user-select: none; 
      padding: 8px 0;
      transition: color 0.2s;
    }
    
    .help-toggle:hover {
      color: #f59e0b;
    }
    
    .help-content { 
      display: none; 
      margin-top: 10px; 
      line-height: 1.6; 
      font-size: 0.9rem; 
      color: #cfe7ff; 
    }
    
    .help-open .help-content { 
      display: block; 
    }

    /* Popup table small styling */
    .leaflet-popup-content table { 
      border-collapse: collapse; 
      font-size: 0.85rem; 
      margin: 0;
    }
    
    .leaflet-popup-content td { 
      padding: 3px 6px; 
      border: 1px solid #ddd; 
    }
    
    .leaflet-popup-content-wrapper {
      border-radius: 8px;
    }

    /* Status message */
    .status-container {
      margin-top: 12px;
      font-size: 0.9rem;
    }
    
    .status-label {
      font-weight: bold;
      color: #cfe7ff;
    }
    
    #statusMsg {
      margin-top: 6px; 
      padding: 8px;
      background: rgba(15, 23, 42, 0.5);
      border-radius: 4px;
      min-height: 20px;
      color: #f8fafc;
      font-size: 0.9rem;
    }

    /* File info */
    .file-info {
      margin-top: 10px;
      padding: 8px;
      background: rgba(245, 158, 11, 0.1);
      border-radius: 4px;
      font-size: 0.85rem;
      display: none;
    }

    /* Coordinate converter */
    .coord-converter {
      background: rgba(15, 23, 42, 0.5);
      border-radius: 6px;
      padding: 10px;
      margin-top: 10px;
    }
    
    .coord-input {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      background: #0b1220;
      border: 1px solid #334155;
      border-radius: 4px;
      color: white;
      direction: ltr;
      text-align: center;
    }
    
    .coord-result {
      margin-top: 8px;
      padding: 8px;
      background: rgba(34, 197, 94, 0.1);
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.85rem;
      display: none;
    }

    /* Measurement results */
    .measurement-result {
      margin-top: 8px;
      padding: 8px;
      background: rgba(59, 130, 246, 0.1);
      border-radius: 4px;
      font-size: 0.9rem;
      display: none;
    }

    /* Label controls */
    .label-controls {
      background: rgba(15, 23, 42, 0.5);
      border-radius: 6px;
      padding: 10px;
      margin-top: 10px;
    }
    
    .field-select {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      background: #0b1220;
      border: 1px solid #334155;
      border-radius: 4px;
      color: white;
      direction: rtl;
    }
    
    .label-preview {
      margin-top: 8px;
      padding: 8px;
      background: rgba(59, 130, 246, 0.1);
      border-radius: 4px;
      font-size: 0.9rem;
      text-align: center;
      display: none;
    }

    /* Tool controls */
    .tool-controls {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 10px;
    }
    
    .tool-btn {
      background: #475569;
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
      font-size: 0.9rem;
    }
    
    .tool-btn:hover {
      background: #64748b;
    }
    
    .tool-btn.active {
      background: #2563eb;
      box-shadow: 0 0 0 2px #3b82f6;
    }

    /* Fullscreen mode */
    .fullscreen .container {
      grid-template-columns: 1fr;
      grid-template-rows: 70px 1fr;
      padding: 0;
      gap: 0;
    }
    
    .fullscreen .header {
      grid-column: 1;
      border-radius: 0;
      margin: 0;
    }
    
    .fullscreen .sidebar {
      display: none;
    }
    
    .fullscreen .table-container {
      display: none;
    }
    
    .fullscreen #map {
      border-radius: 0;
      grid-column: 1;
      grid-row: 2;
    }
    
    .fullscreen .signature {
      bottom: 60px;
    }
    
    .fullscreen .map-info {
      bottom: 60px;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .container { 
        grid-template-columns: 1fr; 
        grid-template-rows: 70px auto 360px 200px; 
      }
      
      .header { 
        grid-column: 1; 
        flex-direction: column;
        gap: 5px;
        text-align: center;
      }
      
      .header-controls {
        justify-content: center;
        flex-wrap: wrap;
      }
      
      .table-container { 
        grid-column: 1; 
      }
      
      .signature { 
        right: auto; 
        left: 14px; 
      }
      
      .map-info {
        left: 50%;
        transform: translateX(-50%);
        bottom: 60px;
      }
    }
    
    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #0b1220;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #2563eb;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #1d4ed8;
    }
    
    /* Leaflet Draw customization */
    .leaflet-draw-toolbar {
      margin-top: 10px;
    }
    
    .leaflet-draw-actions {
      direction: ltr;
    }
    
    .measurement-label {
      background: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-weight: bold;
      color: #333;
    }
    
    /* Persian label styling with transparent background */
    .persian-label {
      font-family: 'Tahoma', 'Segoe UI', sans-serif;
      font-size: 12px;
      font-weight: bold;
      text-shadow: 
        1px 1px 2px rgba(0, 0, 0, 0.8),
        -1px -1px 2px rgba(0, 0, 0, 0.8),
        1px -1px 2px rgba(0, 0, 0, 0.8),
        -1px 1px 2px rgba(0, 0, 0, 0.8);
      padding: 2px 6px;
      background: rgba(255, 255, 255, 0.85);
      border-radius: 4px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      direction: rtl;
      white-space: nowrap;
      backdrop-filter: blur(2px);
    }
    
    /* Transparent label variants */
    .transparent-label {
      background: rgba(255, 255, 255, 0.75) !important;
      backdrop-filter: blur(3px);
      border: 1px solid rgba(255, 255, 255, 0.4);
    }
    
    .semi-transparent-label {
      background: rgba(255, 255, 255, 0.6) !important;
      backdrop-filter: blur(4px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .clear-label {
      background: rgba(255, 255, 255, 0.45) !important;
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    /* Fix for Persian text in tables */
    .persian-text {
      direction: rtl;
      text-align: right;
      font-family: 'Tahoma', 'Segoe UI', sans-serif;
    }
    
    /* Fix for popup content */
    .leaflet-popup-content {
      direction: rtl;
      text-align: right;
      font-family: 'Tahoma', 'Segoe UI', sans-serif;
    }
    
    /* UTF-8 text styling */
    .utf8-text {
      font-family: 'Tahoma', 'Segoe UI', 'Arial', sans-serif;
      unicode-bidi: plaintext;
    }
    
    /* Label transparency controls */
    .transparency-controls {
      display: flex;
      gap: 8px;
      margin: 8px 0;
    }
    
    .transparency-btn {
      flex: 1;
      padding: 6px;
      border: 1px solid #334155;
      background: #0b1220;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s;
    }
    
    .transparency-btn:hover {
      background: #1e293b;
    }
    
    .transparency-btn.active {
      background: #2563eb;
      border-color: #3b82f6;
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1><i class="fas fa-map-marked-alt"></i> Ø³ÛŒØ³ØªÙ… GIS Ø®Ø±Ù…â€ŒØ¢Ø¨Ø§Ø¯</h1>
      <div class="designer">Ø§Ø³ØªØ§Ù† Ù„Ø±Ø³ØªØ§Ù† â€” Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· <strong>Ø§Ú©Ø¨Ø± ÙØªØ­ÛŒâ€ŒÙ¾ÙˆØ±</strong></div>
      <div class="header-controls">
        <button class="header-btn" id="fullscreenBtn" title="Ù†Ù…Ø§ÛŒØ´ ØªÙ…Ø§Ù… ØµÙØ­Ù‡">
          <i class="fas fa-expand"></i>
          <span>ØªÙ…Ø§Ù… ØµÙØ­Ù‡</span>
        </button>
        <button class="header-btn" id="measureBtn" title="Ø§Ø¨Ø²Ø§Ø± Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒ">
          <i class="fas fa-ruler"></i>
          <span>Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒ</span>
        </button>
        <button class="header-btn" id="drawBtn" title="Ø§Ø¨Ø²Ø§Ø± ØªØ±Ø³ÛŒÙ…">
          <i class="fas fa-draw-polygon"></i>
          <span>ØªØ±Ø³ÛŒÙ…</span>
        </button>
        <button class="header-btn" id="labelBtn" title="Ù„ÛŒØ¨Ù„â€ŒÚ¯Ø°Ø§Ø±ÛŒ">
          <i class="fas fa-tag"></i>
          <span>Ù„ÛŒØ¨Ù„â€ŒÚ¯Ø°Ø§Ø±ÛŒ</span>
        </button>
        <button class="header-btn" id="coordBtn" title="ØªØ¨Ø¯ÛŒÙ„ Ù…Ø®ØªØµØ§Øª">
          <i class="fas fa-crosshairs"></i>
          <span>ØªØ¨Ø¯ÛŒÙ„ Ù…Ø®ØªØµØ§Øª</span>
        </button>
        <button class="header-btn" id="resetViewBtn" title="Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒ Ù†Ù‚Ø´Ù‡">
          <i class="fas fa-home"></i>
          <span>Ù…Ø±Ú©Ø² Ù†Ù‚Ø´Ù‡</span>
        </button>
      </div>
    </header>

    <aside class="sidebar">
      <div class="panel">
        <h3><i class="fas fa-upload"></i> Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Shapefile</h3>
        <div id="dropZone" class="upload-area" title="Ú©Ù„ÛŒÚ© ÛŒØ§ Ú©Ø´ÛŒØ¯Ù† Ùˆ Ø±Ù‡Ø§ Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§">
          <div style="font-size: 2.6rem; color: #f59e0b;">
            <i class="fas fa-cloud-upload-alt"></i>
          </div>
          <div style="font-size: 1rem; font-weight: 700;">ÙØ§ÛŒÙ„ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø±Ù‡Ø§ Ú©Ù†ÛŒØ¯</div>
          <div style="font-size: 0.9rem; color: #94a3b8; margin-top: 6px;">ÛŒØ§ Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ â€” ÙØ±Ù…Øª: ZIP ÛŒØ§ (SHP, SHX, DBF, PRJ)</div>
        </div>

        <input id="fileInput" type="file" accept=".zip,.shp,.shx,.dbf,.prj" multiple style="display: none;">
        
        <div id="fileInfo" class="file-info">
          <i class="fas fa-info-circle"></i> <span id="fileInfoText"></span>
        </div>

        <div class="btn-row">
          <button class="btn" id="processBtn">
            <i class="fas fa-bolt"></i> Ù¾Ø±Ø¯Ø§Ø²Ø´ Ùˆ Ù†Ù…Ø§ÛŒØ´
          </button>
          <button class="btn btn-outline" id="clearBtn">
            <i class="fas fa-broom"></i> Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ
          </button>
        </div>

        <div class="btn-row">
          <button class="btn btn-success" id="exportBtn">
            <i class="fas fa-download"></i> Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø®Ø±ÙˆØ¬ÛŒ
          </button>
          <button class="btn btn-warning" id="exportDrawingBtn">
            <i class="fas fa-save"></i> Ø°Ø®ÛŒØ±Ù‡ ØªØ±Ø³ÛŒÙ…
          </button>
        </div>

        <div class="status-container">
          <span class="status-label">ÙˆØ¶Ø¹ÛŒØª:</span>
          <div id="statusMsg">Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</div>
        </div>
      </div>

      <div class="panel">
        <h3><i class="fas fa-layer-group"></i> Ù„Ø§ÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÙ‡</h3>
        <p style="color: #cfe7ff; margin: 6px 0 8px 0; font-size: 0.9rem;">Ø¨Ø§ Ø§Ù…Ú©Ø§Ù† Ø³ÙˆÛŒÚ† Ø¨ÛŒÙ† Ù†Ù‚Ø´Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÙ‡</p>
        <div style="display: flex; flex-direction: column; gap: 8px;">
          <button class="btn btn-outline" id="osmBtn">
            <i class="fas fa-map"></i> OpenStreetMap
          </button>
          <button class="btn btn-outline" id="googleSatBtn">
            <i class="fas fa-satellite"></i> Google Satellite
          </button>
          <button class="btn btn-outline" id="topoBtn">
            <i class="fas fa-mountain"></i> ØªÙˆÙ¾ÙˆÚ¯Ø±Ø§ÙÛŒ
          </button>
          <button class="btn btn-outline" id="cartoBtn">
            <i class="fas fa-palette"></i> CartoDB Voyager
          </button>
        </div>
      </div>

      <div class="panel" id="measurementPanel" style="display: none;">
        <h3><i class="fas fa-ruler"></i> Ø§Ø¨Ø²Ø§Ø± Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒ</h3>
        <div class="tool-controls">
          <button class="tool-btn" id="measureLengthBtn">
            <i class="fas fa-ruler-horizontal"></i> Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒ Ø·ÙˆÙ„
          </button>
          <button class="tool-btn" id="measureAreaBtn">
            <i class="fas fa-vector-square"></i> Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒ Ù…Ø³Ø§Ø­Øª
          </button>
          <button class="tool-btn" id="clearMeasurementsBtn">
            <i class="fas fa-trash"></i> Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒâ€ŒÙ‡Ø§
          </button>
        </div>
        <div id="measurementResult" class="measurement-result"></div>
      </div>

      <div class="panel" id="drawingPanel" style="display: none;">
        <h3><i class="fas fa-draw-polygon"></i> Ø§Ø¨Ø²Ø§Ø± ØªØ±Ø³ÛŒÙ…</h3>
        <div class="tool-controls">
          <button class="tool-btn" id="drawMarkerBtn">
            <i class="fas fa-map-marker-alt"></i> Ù†Ù‚Ø·Ù‡
          </button>
          <button class="tool-btn" id="drawPolylineBtn">
            <i class="fas fa-draw-polygon"></i> Ø®Ø·
          </button>
          <button class="tool-btn" id="drawPolygonBtn">
            <i class="fas fa-square"></i> Ú†Ù†Ø¯Ø¶Ù„Ø¹ÛŒ
          </button>
          <button class="tool-btn" id="drawRectangleBtn">
            <i class="fas fa-vector-square"></i> Ù…Ø³ØªØ·ÛŒÙ„
          </button>
          <button class="tool-btn" id="drawCircleBtn">
            <i class="fas fa-circle"></i> Ø¯Ø§ÛŒØ±Ù‡
          </button>
          <button class="tool-btn" id="clearDrawingsBtn">
            <i class="fas fa-trash"></i> Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ ØªØ±Ø³ÛŒÙ…â€ŒÙ‡Ø§
          </button>
        </div>
      </div>

      <div class="panel" id="labelPanel" style="display: none;">
        <h3><i class="fas fa-tag"></i> Ù„ÛŒØ¨Ù„â€ŒÚ¯Ø°Ø§Ø±ÛŒ</h3>
        <div class="label-controls">
          <div style="margin-bottom: 8px; font-size: 0.9rem;">Ø§Ù†ØªØ®Ø§Ø¨ ÙÛŒÙ„Ø¯ Ø¨Ø±Ø§ÛŒ Ù„ÛŒØ¨Ù„â€ŒÚ¯Ø°Ø§Ø±ÛŒ:</div>
          <select id="labelFieldSelect" class="field-select">
            <option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ ÙÛŒÙ„Ø¯ --</option>
          </select>
          
          <div style="margin: 10px 0; font-size: 0.9rem;">Ø´ÙØ§ÙÛŒØª Ù„ÛŒØ¨Ù„:</div>
          <div class="transparency-controls">
            <button class="transparency-btn active" data-transparency="transparent">Ø´ÙØ§Ù</button>
            <button class="transparency-btn" data-transparency="semi-transparent">Ù†ÛŒÙ…Ù‡ Ø´ÙØ§Ù</button>
            <button class="transparency-btn" data-transparency="clear">Ú©Ø§Ù…Ù„Ø§Ù‹ Ø´ÙØ§Ù</button>
          </div>
          
          <div style="margin: 10px 0; font-size: 0.9rem;">ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù„ÛŒØ¨Ù„:</div>
          
          <div style="display: flex; gap: 8px; margin-bottom: 8px;">
            <select id="labelFontSize" class="field-select" style="flex: 1;">
              <option value="10">Ø³Ø§ÛŒØ² Û±Û°</option>
              <option value="12" selected>Ø³Ø§ÛŒØ² Û±Û²</option>
              <option value="14">Ø³Ø§ÛŒØ² Û±Û´</option>
              <option value="16">Ø³Ø§ÛŒØ² Û±Û¶</option>
              <option value="18">Ø³Ø§ÛŒØ² Û±Û¸</option>
            </select>
            
            <select id="labelColor" class="field-select" style="flex: 1;">
              <option value="#000000" style="color: black;">Ù…Ø´Ú©ÛŒ</option>
              <option value="#dc2626" style="color: #dc2626;">Ù‚Ø±Ù…Ø²</option>
              <option value="#2563eb" style="color: #2563eb;">Ø¢Ø¨ÛŒ</option>
              <option value="#16a34a" style="color: #16a34a;">Ø³Ø¨Ø²</option>
              <option value="#d97706" style="color: #d97706;">Ù†Ø§Ø±Ù†Ø¬ÛŒ</option>
              <option value="#7c3aed" style="color: #7c3aed;">Ø¨Ù†ÙØ´</option>
              <option value="#ffffff" style="color: white; background: #666;">Ø³ÙÛŒØ¯</option>
            </select>
          </div>
          
          <div class="btn-row">
            <button class="btn btn-success" id="applyLabelsBtn">
              <i class="fas fa-tag"></i> Ø§Ø¹Ù…Ø§Ù„ Ù„ÛŒØ¨Ù„â€ŒÙ‡Ø§
            </button>
            <button class="btn btn-outline" id="clearLabelsBtn">
              <i class="fas fa-eye-slash"></i> Ø­Ø°Ù Ù„ÛŒØ¨Ù„â€ŒÙ‡Ø§
            </button>
          </div>
          
          <div id="labelPreview" class="label-preview">
            Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ù„ÛŒØ¨Ù„
          </div>
        </div>
      </div>

      <div class="panel" id="coordinatePanel" style="display: none;">
        <h3><i class="fas fa-crosshairs"></i> ØªØ¨Ø¯ÛŒÙ„ Ù…Ø®ØªØµØ§Øª</h3>
        <div class="coord-converter">
          <div style="margin-bottom: 8px; font-size: 0.9rem;">Ù…Ø®ØªØµØ§Øª Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ (Lat, Lon):</div>
          <input type="text" id="latInput" class="coord-input" placeholder="Ø¹Ø±Ø¶ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ (Ù…Ø«Ø§Ù„: 33.4871)">
          <input type="text" id="lonInput" class="coord-input" placeholder="Ø·ÙˆÙ„ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ (Ù…Ø«Ø§Ù„: 48.3538)">
          <button class="btn btn-outline" id="convertToUTMBtn" style="margin-top: 8px;">
            <i class="fas fa-sync-alt"></i> ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ UTM
          </button>
          <div id="utmResult" class="coord-result"></div>
        </div>
      </div>

      <div class="panel">
        <div class="help-toggle" id="helpToggle">
          <i class="fas fa-question-circle"></i>
          <b>Ø±Ø§Ù‡Ù†Ù…Ø§ (Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯)</b>
        </div>
        <div class="help-content" id="helpContent">
          <h4><i class="fas fa-life-ring"></i> Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ú©Ø§Ù…Ù„ â€” Ú¯Ø§Ù…â€ŒØ¨Ù‡â€ŒÚ¯Ø§Ù…</h4>
          <ol>
            <li><strong>Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„:</strong> ÙØ§ÛŒÙ„ ZIP Ø­Ø§ÙˆÛŒ SHP/SHX/DBF/PRJ Ø±Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯</li>
            <li><strong>Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒ:</strong> Ø§Ø² Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒ Ø·ÙˆÙ„ Ùˆ Ù…Ø³Ø§Ø­Øª Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯</li>
            <li><strong>ØªØ±Ø³ÛŒÙ…:</strong> Ø§Ø´Ú©Ø§Ù„ Ù…Ø®ØªÙ„Ù Ø±Ø§ Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡ ØªØ±Ø³ÛŒÙ… Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯</li>
            <li><strong>Ù„ÛŒØ¨Ù„â€ŒÚ¯Ø°Ø§Ø±ÛŒ:</strong> Ø¨Ø§ Ø§Ù†ØªØ®Ø§Ø¨ ÙÛŒÙ„Ø¯ØŒ Ù„ÛŒØ¨Ù„ ÙØ§Ø±Ø³ÛŒ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ UTF-8 Ù†Ù…Ø§ÛŒØ´ Ø¯Ù‡ÛŒØ¯</li>
            <li><strong>Ø´ÙØ§ÙÛŒØª:</strong> Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø´ÙØ§ÙÛŒØª Ø¨Ø±Ø§ÛŒ ØªÙ†Ø¸ÛŒÙ… Ø¸Ø§Ù‡Ø± Ù„ÛŒØ¨Ù„â€ŒÙ‡Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯</li>
            <li><strong>ØªØ¨Ø¯ÛŒÙ„ Ù…Ø®ØªØµØ§Øª:</strong> Ù…Ø®ØªØµØ§Øª Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ Ø±Ø§ Ø¨Ù‡ UTM ØªØ¨Ø¯ÛŒÙ„ Ú©Ù†ÛŒØ¯</li>
            <li><strong>Ø®Ø±ÙˆØ¬ÛŒ:</strong> Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ùˆ ØªØ±Ø³ÛŒÙ…â€ŒÙ‡Ø§ Ø±Ø§ Ø¯Ø± Ù‚Ø§Ù„Ø¨ Shapefile Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†ÛŒØ¯</li>
          </ol>
        </div>
      </div>
    </aside>

    <main style="position: relative;">
      <div id="map"></div>
      <div class="loading" id="loadingOverlay">
        <div class="spinner"></div>
      </div>

      <div class="signature" aria-hidden="true">
        <div style="width: 22px; height: 22px; border-radius: 6px; background: #2563eb; display: flex; align-items: center; justify-content: center;">
          <i class="fas fa-code" style="color: white; font-size: 12px;"></i>
        </div>
        <div style="font-size: 0.95rem;">Ø·Ø±Ø§Ø­ÛŒ: <strong>Ø§Ú©Ø¨Ø± ÙØªØ­ÛŒâ€ŒÙ¾ÙˆØ±</strong></div>
      </div>

      <div class="map-info">
        <div class="coord-display" id="mouseCoords">Ù…Ø®ØªØµØ§Øª: â€”</div>
        <div class="scale-display" id="mapScale">Ù…Ù‚ÛŒØ§Ø³: â€”</div>
      </div>
    </main>

    <section class="table-container">
      <h3><i class="fas fa-table"></i> Ø¬Ø¯ÙˆÙ„ ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§</h3>
      <div id="attributes">Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ù„Ø·ÙØ§Ù‹ ÛŒÚ© ÙØ§ÛŒÙ„ Shapefile Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯.</div>
    </section>
  </div>

  <!-- Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
  <script src="https://unpkg.com/shpjs@latest/dist/shp.min.js"></script>
  <script src="https://unpkg.com/shp-write@1.3.0/dist/shpwrite.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>

  <script>
    // ====== ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡ Ù†Ù‚Ø´Ù‡ ======
    const KHORRAMABAD = [33.4871, 48.3538];
    let map, geoLayer = null, lastGeoJSON = null;
    let baseLayers = {}, baseLayerControl;
    let isFullscreen = false;
    let drawControl, measureControl;
    let drawnItems = new L.FeatureGroup();
    let measureItems = new L.FeatureGroup();
    let labelLayer = new L.FeatureGroup();
    let currentLabels = [];
    let currentTransparency = 'transparent';

    // ØªØ¹Ø±ÛŒÙ Ø³ÛŒØ³ØªÙ… Ù…Ø®ØªØµØ§Øª UTM Ø¨Ø±Ø§ÛŒ Ù…Ù†Ø·Ù‚Ù‡ Ø®Ø±Ù…â€ŒØ¢Ø¨Ø§Ø¯ (UTM Zone 39N)
    proj4.defs("EPSG:32639", "+proj=utm +zone=39 +ellps=WGS84 +datum=WGS84 +units=m +no_defs");

    function initMap() {
      map = L.map('map').setView(KHORRAMABAD, 12);

      // ØªØ¹Ø§Ø±ÛŒÙ Ù„Ø§ÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÙ‡
      const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap'
      });

      const carto = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; CartoDB'
      });

      const googleSat = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
        attribution: '&copy; Google'
      });

      // Ù„Ø§ÛŒÙ‡ ØªÙˆÙ¾ÙˆÚ¯Ø±Ø§ÙÛŒ
      const topo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenTopoMap',
        maxZoom: 17
      });

      baseLayers = {
        "OpenStreetMap â€” Ø®ÛŒØ§Ø¨Ø§Ù†": osm,
        "Google Satellite â€” Ù…Ø§Ù‡ÙˆØ§Ø±Ù‡â€ŒØ§ÛŒ Ú¯ÙˆÚ¯Ù„": googleSat,
        "ØªÙˆÙ¾ÙˆÚ¯Ø±Ø§ÙÛŒ â€” OpenTopoMap": topo,
        "CartoDB Voyager â€” Ù…Ù„Ø§ÛŒÙ…": carto
      };

      // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù„Ø§ÛŒÙ‡ ØªÙˆÙ¾ÙˆÚ¯Ø±Ø§ÙÛŒ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù¾ÛŒØ´â€ŒÙØ±Ø¶
      topo.addTo(map);

      // Ú©Ù†ØªØ±Ù„ Ù„Ø§ÛŒÙ‡â€ŒÙ‡Ø§
      baseLayerControl = L.control.layers(baseLayers, null, { position: 'topright' }).addTo(map);

      // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù„Ø§ÛŒÙ‡ ØªØ±Ø³ÛŒÙ…â€ŒÙ‡Ø§ Ùˆ Ù„ÛŒØ¨Ù„â€ŒÙ‡Ø§ Ø¨Ù‡ Ù†Ù‚Ø´Ù‡
      drawnItems.addTo(map);
      measureItems.addTo(map);
      labelLayer.addTo(map);

      // Ù†Ø´Ø§Ù†Ú¯Ø± Ù…Ø±Ú©Ø²
      L.marker(KHORRAMABAD).addTo(map)
        .bindPopup('<div style="text-align: center;"><strong>Ø®Ø±Ù…â€ŒØ¢Ø¨Ø§Ø¯</strong><br>Ù…Ø±Ú©Ø² Ø§Ø³ØªØ§Ù† Ù„Ø±Ø³ØªØ§Ù†</div>')
        .openPopup();

      // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ÛŒ ØªØ±Ø³ÛŒÙ…
      initDrawControls();
      initMeasureControls();

      // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù…Ø®ØªØµØ§Øª Ùˆ Ù…Ù‚ÛŒØ§Ø³
      initMapInfo();

      setupUpload();
      setupButtons();
      setupFullscreen();
      setupLabelControls();
    }

    // ====== ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ÛŒ Ù„ÛŒØ¨Ù„â€ŒÚ¯Ø°Ø§Ø±ÛŒ ======
    function setupLabelControls() {
      const fieldSelect = document.getElementById('labelFieldSelect');
      const fontSizeSelect = document.getElementById('labelFontSize');
      const colorSelect = document.getElementById('labelColor');
      const preview = document.getElementById('labelPreview');
      const transparencyBtns = document.querySelectorAll('.transparency-btn');

      // Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø´ÙØ§ÙÛŒØª
      transparencyBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          transparencyBtns.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          currentTransparency = this.getAttribute('data-transparency');
          updatePreview();
        });
      });

      // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ù„ÛŒØ¨Ù„
      function updatePreview() {
        const fontSize = fontSizeSelect.value;
        const color = colorSelect.value;
        const sampleText = "Ù†Ù…ÙˆÙ†Ù‡ Ù…ØªÙ† ÙØ§Ø±Ø³ÛŒ UTF-8";
        
        preview.innerHTML = sampleText;
        preview.style.fontSize = fontSize + 'px';
        preview.style.color = color;
        preview.style.fontWeight = 'bold';
        preview.style.display = 'block';
        preview.className = `label-preview persian-text utf8-text ${currentTransparency}-label`;
        
        // Ø§Ø¹Ù…Ø§Ù„ Ø´ÙØ§ÙÛŒØª Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±
        switch(currentTransparency) {
          case 'transparent':
            preview.style.background = 'rgba(255, 255, 255, 0.85)';
            preview.style.backdropFilter = 'blur(2px)';
            break;
          case 'semi-transparent':
            preview.style.background = 'rgba(255, 255, 255, 0.6)';
            preview.style.backdropFilter = 'blur(4px)';
            break;
          case 'clear':
            preview.style.background = 'rgba(255, 255, 255, 0.45)';
            preview.style.backdropFilter = 'blur(5px)';
            break;
        }
      }

      fontSizeSelect.addEventListener('change', updatePreview);
      colorSelect.addEventListener('change', updatePreview);
      
      // Ù…Ù‚Ø¯Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´
      updatePreview();
    }

    // ====== Ù„ÛŒØ¨Ù„â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± ======
    function applyLabels() {
      const fieldSelect = document.getElementById('labelFieldSelect');
      const selectedField = fieldSelect.value;
      const fontSize = document.getElementById('labelFontSize').value;
      const color = document.getElementById('labelColor').value;

      if (!selectedField) {
        alert('Ù„Ø·ÙØ§Ù‹ ÛŒÚ© ÙÛŒÙ„Ø¯ Ø¨Ø±Ø§ÛŒ Ù„ÛŒØ¨Ù„â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.');
        return;
      }

      if (!lastGeoJSON) {
        alert('Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù„ÛŒØ¨Ù„â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.');
        return;
      }

      // Ø­Ø°Ù Ù„ÛŒØ¨Ù„â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
      clearLabels();

      document.getElementById('statusMsg').innerText = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¹Ù…Ø§Ù„ Ù„ÛŒØ¨Ù„â€ŒÙ‡Ø§...';

      let labelCount = 0;

      lastGeoJSON.features.forEach((feature, index) => {
        if (feature.properties && feature.properties[selectedField]) {
          let labelText = feature.properties[selectedField];
          
          // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø±Ø´ØªÙ‡ Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ùˆ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² UTF-8
          labelText = String(labelText);
          
          // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² TextDecoder Ø¨Ø±Ø§ÛŒ decode Ú©Ø±Ø¯Ù† UTF-8
          labelText = decodeUTF8Text(labelText);
          
          // ØªØ´Ø®ÛŒØµ Ø®ÙˆØ¯Ú©Ø§Ø± Ù…ØªÙ† ÙØ§Ø±Ø³ÛŒ
          const isPersian = isPersianText(labelText);
          
          if (labelText && labelText !== '' && labelText !== 'null' && labelText !== 'undefined') {
            let latlng;
            
            // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¨Ø±Ø§ÛŒ Ù„ÛŒØ¨Ù„ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹ Ù‡Ù†Ø¯Ø³Ù‡
            if (feature.geometry.type === 'Point') {
              latlng = L.latLng(feature.geometry.coordinates[1], feature.geometry.coordinates[0]);
            } else if (feature.geometry.type === 'Polygon') {
              // Ù…Ø±Ú©Ø² Ú†Ù†Ø¯Ø¶Ù„Ø¹ÛŒ
              const coords = feature.geometry.coordinates[0];
              const center = getPolygonCenter(coords);
              latlng = L.latLng(center.lat, center.lng);
            } else if (feature.geometry.type === 'LineString') {
              // Ù†Ù‚Ø·Ù‡ Ù…ÛŒØ§Ù†ÛŒ Ø®Ø·
              const coords = feature.geometry.coordinates;
              const midIndex = Math.floor(coords.length / 2);
              latlng = L.latLng(coords[midIndex][1], coords[midIndex][0]);
            } else if (feature.geometry.type === 'MultiPolygon') {
              // Ø§ÙˆÙ„ÛŒÙ† Ú†Ù†Ø¯Ø¶Ù„Ø¹ÛŒ Ø¯Ø± MultiPolygon
              const coords = feature.geometry.coordinates[0][0];
              const center = getPolygonCenter(coords);
              latlng = L.latLng(center.lat, center.lng);
            } else {
              return; // Ù†ÙˆØ¹ Ù‡Ù†Ø¯Ø³Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯
            }

            // ØªÙ†Ø¸ÛŒÙ… Ø´ÙØ§ÙÛŒØª Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±
            let transparencyClass = '';
            let backgroundStyle = '';
            
            switch(currentTransparency) {
              case 'transparent':
                transparencyClass = 'transparent-label';
                backgroundStyle = 'rgba(255, 255, 255, 0.85)';
                break;
              case 'semi-transparent':
                transparencyClass = 'semi-transparent-label';
                backgroundStyle = 'rgba(255, 255, 255, 0.6)';
                break;
              case 'clear':
                transparencyClass = 'clear-label';
                backgroundStyle = 'rgba(255, 255, 255, 0.45)';
                break;
            }

            // Ø§ÛŒØ¬Ø§Ø¯ Ù„ÛŒØ¨Ù„ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ UTF-8 Ùˆ Ø´ÙØ§ÙÛŒØª
            const label = L.marker(latlng, {
              icon: L.divIcon({
                className: `persian-label utf8-text ${transparencyClass}`,
                html: `<div style="font-size: ${fontSize}px; color: ${color}; font-weight: bold; 
                       text-shadow: 1px 1px 2px rgba(0,0,0,0.8), -1px -1px 2px rgba(0,0,0,0.8), 
                       1px -1px 2px rgba(0,0,0,0.8), -1px 1px 2px rgba(0,0,0,0.8);
                       background: ${backgroundStyle}; 
                       backdrop-filter: blur(3px);
                       padding: 2px 6px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.3); 
                       direction: ${isPersian ? 'rtl' : 'ltr'}; 
                       font-family: Tahoma, Segoe UI, Arial, sans-serif; 
                       white-space: nowrap; unicode-bidi: plaintext;">${labelText}</div>`,
                iconSize: [null, null],
                iconAnchor: [0, 0]
              })
            });

            label.addTo(labelLayer);
            currentLabels.push(label);
            labelCount++;
          }
        }
      });

      document.getElementById('statusMsg').innerText = `${labelCount} Ù„ÛŒØ¨Ù„ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ UTF-8 Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯.`;
    }

    // ====== decode Ú©Ø±Ø¯Ù† Ù…ØªÙ† UTF-8 ======
    function decodeUTF8Text(text) {
      if (typeof text !== 'string') return text;
      
      try {
        // Ø§Ú¯Ø± Ù…ØªÙ† Ø­Ø§ÙˆÛŒ Ú©Ø§Ø±Ø§Ú©ØªØ±Ù‡Ø§ÛŒ UTF-8 encoded Ø¨Ø§Ø´Ø¯
        if (text.includes('\\u')) {
          return JSON.parse(`"${text}"`);
        }
        
        // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² TextDecoder Ø¨Ø±Ø§ÛŒ decode Ú©Ø±Ø¯Ù†
        if (typeof TextDecoder !== 'undefined') {
          const encoder = new TextEncoder();
          const decoder = new TextDecoder('utf-8');
          const encoded = encoder.encode(text);
          return decoder.decode(encoded);
        }
        
        return text;
      } catch (e) {
        console.warn('Ø®Ø·Ø§ Ø¯Ø± decode Ú©Ø±Ø¯Ù† UTF-8:', e);
        return text;
      }
    }

    // ====== ØªØ´Ø®ÛŒØµ Ù…ØªÙ† ÙØ§Ø±Ø³ÛŒ ======
    function isPersianText(text) {
      if (!text) return false;
      
      const persianRegex = /[\u0600-\u06FF\uFB8A\u067E\u0686\u06AF\u200C\u200F]/;
      const englishRegex = /[a-zA-Z]/;
      
      let persianCount = 0;
      let englishCount = 0;
      
      const textStr = String(text);
      
      for (let i = 0; i < textStr.length; i++) {
        const char = textStr.charAt(i);
        if (persianRegex.test(char)) persianCount++;
        if (englishRegex.test(char)) englishCount++;
      }
      
      return persianCount > englishCount;
    }

    // ====== Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø±Ú©Ø² Ú†Ù†Ø¯Ø¶Ù„Ø¹ÛŒ ======
    function getPolygonCenter(coords) {
      let minLat = 90, maxLat = -90, minLng = 180, maxLng = -180;
      
      coords.forEach(coord => {
        const lng = coord[0];
        const lat = coord[1];
        
        if (lat < minLat) minLat = lat;
        if (lat > maxLat) maxLat = lat;
        if (lng < minLng) minLng = lng;
        if (lng > maxLng) maxLng = lng;
      });
      
      return {
        lat: (minLat + maxLat) / 2,
        lng: (minLng + maxLng) / 2
      };
    }

    // ====== Ø­Ø°Ù Ù„ÛŒØ¨Ù„â€ŒÙ‡Ø§ ======
    function clearLabels() {
      currentLabels.forEach(label => {
        labelLayer.removeLayer(label);
      });
      currentLabels = [];
      document.getElementById('statusMsg').innerText = 'Ù„ÛŒØ¨Ù„â€ŒÙ‡Ø§ Ø­Ø°Ù Ø´Ø¯Ù†Ø¯.';
    }

    // ====== Ù¾Ø± Ú©Ø±Ø¯Ù† Ù„ÛŒØ³Øª ÙÛŒÙ„Ø¯Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ù„ÛŒØ¨Ù„â€ŒÚ¯Ø°Ø§Ø±ÛŒ ======
    function populateLabelFields(geojson) {
      const fieldSelect = document.getElementById('labelFieldSelect');
      fieldSelect.innerHTML = '<option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ ÙÛŒÙ„Ø¯ --</option>';
      
      if (geojson.features && geojson.features.length > 0) {
        const fields = Object.keys(geojson.features[0].properties || {});
        
        // Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒØ¨Ù†Ø¯ÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø­ØªÙˆØ§ÛŒ ÙØ§Ø±Ø³ÛŒ
        const prioritizedFields = [];
        const otherFields = [];
        
        fields.forEach(field => {
          // Ù†Ù…ÙˆÙ†Ù‡â€ŒÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù…Ù‚Ø§Ø¯ÛŒØ± Ø¨Ø±Ø§ÛŒ ØªØ´Ø®ÛŒØµ ÙØ§Ø±Ø³ÛŒ
          let hasPersianContent = false;
          for (let i = 0; i < Math.min(5, geojson.features.length); i++) {
            const value = geojson.features[i].properties[field];
            if (value && isPersianText(value)) {
              hasPersianContent = true;
              break;
            }
          }
          
          if (hasPersianContent || isPersianText(field)) {
            prioritizedFields.push(field);
          } else {
            otherFields.push(field);
          }
        });
        
        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¨Ø§ Ù…Ø­ØªÙˆØ§ÛŒ ÙØ§Ø±Ø³ÛŒ Ø§ÙˆÙ„
        prioritizedFields.forEach(field => {
          const option = document.createElement('option');
          option.value = field;
          option.textContent = decodeUTF8Text(field);
          option.className = 'persian-text utf8-text';
          option.style.fontFamily = 'Tahoma, sans-serif';
          option.style.direction = 'rtl';
          option.style.unicodeBidi = 'plaintext';
          fieldSelect.appendChild(option);
        });
        
        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø³Ø§ÛŒØ± ÙÛŒÙ„Ø¯Ù‡Ø§
        otherFields.forEach(field => {
          const option = document.createElement('option');
          option.value = field;
          option.textContent = decodeUTF8Text(field);
          option.className = 'utf8-text';
          fieldSelect.appendChild(option);
        });
        
        // Ø§Ú¯Ø± ÙÛŒÙ„Ø¯ÛŒ Ø¨Ø§ Ù†Ø§Ù…â€ŒÙ‡Ø§ÛŒ Ù…ØªØ¯Ø§ÙˆÙ„ ÙØ§Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ØŒ Ø¨Ù‡ Ø·ÙˆØ± Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ø´ÙˆØ¯
        const persianFieldNames = ['name', 'Ù†Ø§Ù…', 'title', 'Ø¹Ù†ÙˆØ§Ù†', 'address', 'Ø¢Ø¯Ø±Ø³', 'city', 'Ø´Ù‡Ø±', 'description', 'ØªÙˆØ¶ÛŒØ­Ø§Øª'];
        for (let fieldName of persianFieldNames) {
          if (fields.includes(fieldName)) {
            fieldSelect.value = fieldName;
            break;
          }
        }
        
        // Ø§Ú¯Ø± ÙÛŒÙ„Ø¯ Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒØ¯Ø§Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ØŒ Ø¢Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†
        if (prioritizedFields.length > 0 && !fieldSelect.value) {
          fieldSelect.value = prioritizedFields[0];
        }
      }
    }

    // ====== Ù†Ù…Ø§ÛŒØ´ Ù…Ø®ØªØµØ§Øª Ùˆ Ù…Ù‚ÛŒØ§Ø³ ======
    function initMapInfo() {
      // Ù†Ù…Ø§ÛŒØ´ Ù…Ø®ØªØµØ§Øª Ù…ÙˆØ³
      map.on('mousemove', function(e) {
        const coords = e.latlng;
        const lat = coords.lat.toFixed(6);
        const lng = coords.lng.toFixed(6);
        
        // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ UTM
        try {
          const utm = convertToUTM(lat, lng);
          document.getElementById('mouseCoords').innerHTML = 
            `Ù…Ø®ØªØµØ§Øª: ${lat}, ${lng}<br>UTM: ${utm.easting}, ${utm.northing} (${utm.zone})`;
        } catch (e) {
          document.getElementById('mouseCoords').innerHTML = 
            `Ù…Ø®ØªØµØ§Øª: ${lat}, ${lng}`;
        }
      });

      // Ù†Ù…Ø§ÛŒØ´ Ù…Ù‚ÛŒØ§Ø³
      function updateScale() {
        const zoom = map.getZoom();
        const scale = calculateScale(zoom);
        document.getElementById('mapScale').textContent = `Ù…Ù‚ÛŒØ§Ø³: 1:${scale.toLocaleString('fa-IR')}`;
      }

      map.on('zoomend', updateScale);
      map.on('moveend', updateScale);
      updateScale(); // Ù…Ù‚Ø¯Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡
    }

    function calculateScale(zoom) {
      // Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªÙ‚Ø±ÛŒØ¨ÛŒ Ù…Ù‚ÛŒØ§Ø³ Ø¨Ø± Ø§Ø³Ø§Ø³ zoom level
      const scaleFactors = {
        1: 500000000,
        2: 200000000,
        3: 100000000,
        4: 50000000,
        5: 25000000,
        6: 12500000,
        7: 6500000,
        8: 3000000,
        9: 1500000,
        10: 750000,
        11: 400000,
        12: 200000,
        13: 100000,
        14: 50000,
        15: 25000,
        16: 12500,
        17: 5000,
        18: 2500,
        19: 1000,
        20: 500
      };
      
      return scaleFactors[zoom] || 1000;
    }

    // ====== Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ÛŒ ØªØ±Ø³ÛŒÙ… ======
    function initDrawControls() {
      drawControl = new L.Control.Draw({
        position: 'topright',
        draw: {
          polygon: {
            allowIntersection: false,
            drawError: {
              color: '#e1e4e8',
              message: '<strong>Ø®Ø·Ø§:</strong> Ø´Ú©Ù„ Ù…Ø¬Ø§Ø² Ù†ÛŒØ³Øª!'
            },
            shapeOptions: {
              color: '#2563eb'
            },
            showArea: true
          },
          polyline: {
            shapeOptions: {
              color: '#2563eb'
            }
          },
          rectangle: {
            shapeOptions: {
              color: '#2563eb'
            }
          },
          circle: {
            shapeOptions: {
              color: '#2563eb'
            }
          },
          marker: {
            icon: new L.Icon.Default()
          }
        },
        edit: {
          featureGroup: drawnItems
        }
      });

      map.on(L.Draw.Event.CREATED, function (e) {
        const type = e.layerType;
        const layer = e.layer;

        if (type === 'marker') {
          layer.bindPopup('Ù†Ù‚Ø·Ù‡ ØªØ±Ø³ÛŒÙ… Ø´Ø¯Ù‡');
        }

        drawnItems.addLayer(layer);
        document.getElementById('statusMsg').innerText = `Ø´Ú©Ù„ ${type} ØªØ±Ø³ÛŒÙ… Ø´Ø¯.`;
      });
    }

    // ====== Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒ ======
    function initMeasureControls() {
      map.on(L.Draw.Event.CREATED, function (e) {
        const layer = e.layer;
        let measureText = '';

        if (e.layerType === 'polyline') {
          const length = calculateLength(layer);
          measureText = `Ø·ÙˆÙ„: ${length}`;
          layer.bindPopup(measureText);
        } else if (e.layerType === 'polygon') {
          const area = calculateArea(layer);
          measureText = `Ù…Ø³Ø§Ø­Øª: ${area}`;
          layer.bindPopup(measureText);
        }

        measureItems.addLayer(layer);
        document.getElementById('measurementResult').innerHTML = measureText;
        document.getElementById('measurementResult').style.display = 'block';
        document.getElementById('statusMsg').innerText = measureText;
      });
    }

    function calculateLength(layer) {
      const latlngs = layer.getLatLngs();
      let total = 0;
      
      for (let i = 0; i < latlngs.length - 1; i++) {
        total += latlngs[i].distanceTo(latlngs[i + 1]);
      }
      
      if (total < 1000) {
        return `${total.toFixed(2)} Ù…ØªØ±`;
      } else {
        return `${(total / 1000).toFixed(2)} Ú©ÛŒÙ„ÙˆÙ…ØªØ±`;
      }
    }

    function calculateArea(layer) {
      const area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
      
      if (area < 1000000) {
        return `${(area / 10000).toFixed(2)} Ù‡Ú©ØªØ§Ø±`;
      } else {
        return `${(area / 1000000).toFixed(2)} Ú©ÛŒÙ„ÙˆÙ…ØªØ± Ù…Ø±Ø¨Ø¹`;
      }
    }

    // ====== ØªØ¨Ø¯ÛŒÙ„ Ù…Ø®ØªØµØ§Øª ======
    function convertToUTM(lat, lon) {
      try {
        const source = 'EPSG:4326'; // WGS84
        const target = 'EPSG:32639'; // UTM Zone 39N
        
        const result = proj4(source, target, [parseFloat(lon), parseFloat(lat)]);
        
        return {
          easting: result[0].toFixed(2),
          northing: result[1].toFixed(2),
          zone: '39N'
        };
      } catch (error) {
        throw new Error('Ø®Ø·Ø§ Ø¯Ø± ØªØ¨Ø¯ÛŒÙ„ Ù…Ø®ØªØµØ§Øª: ' + error.message);
      }
    }

    // ====== Ù…Ø¯ÛŒØ±ÛŒØª Upload Ùˆ Drag & Drop ======
    function setupUpload() {
      const dropZone = document.getElementById('dropZone');
      const fileInput = document.getElementById('fileInput');
      const fileInfo = document.getElementById('fileInfo');
      const fileInfoText = document.getElementById('fileInfoText');

      dropZone.addEventListener('click', () => fileInput.click());

      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault(); 
        dropZone.classList.add('drag');
      });
      
      dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault(); 
        dropZone.classList.remove('drag');
      });
      
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault(); 
        dropZone.classList.remove('drag');
        const dt = e.dataTransfer;
        if (dt && dt.files && dt.files.length > 0) {
          fileInput.files = dt.files;
          updateFileInfo(fileInput.files);
        }
      });

      fileInput.addEventListener('change', () => {
        updateFileInfo(fileInput.files);
      });
      
      function updateFileInfo(files) {
        if (files.length === 0) {
          fileInfo.style.display = 'none';
          return;
        }
        
        let fileNames = [];
        let hasShp = false, hasShx = false, hasDbf = false, hasPrj = false;
        
        for (let file of files) {
          fileNames.push(file.name);
          const ext = file.name.toLowerCase().split('.').pop();
          if (ext === 'shp') hasShp = true;
          if (ext === 'shx') hasShx = true;
          if (ext === 'dbf') hasDbf = true;
          if (ext === 'prj') hasPrj = true;
        }
        
        fileInfoText.innerHTML = `<strong>${files.length} ÙØ§ÛŒÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯:</strong> ${fileNames.join(', ')}`;
        
        if (files.length === 1 && files[0].name.toLowerCase().endsWith('.zip')) {
          fileInfoText.innerHTML += '<br><span style="color:#4ade80;">âœ“ ÙØ§ÛŒÙ„ ZIP Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯</span>';
        } else {
          let status = [];
          if (hasShp) status.push('SHP âœ“');
          if (hasShx) status.push('SHX âœ“');
          if (hasDbf) status.push('DBF âœ“');
          if (hasPrj) status.push('PRJ âœ“');
          
          if (status.length > 0) {
            fileInfoText.innerHTML += `<br><span style="color:#4ade80;">${status.join(', ')}</span>`;
          }
          
          if (!hasShp || !hasShx || !hasDbf) {
            fileInfoText.innerHTML += '<br><span style="color:#f59e0b;">âš  ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ (SHP, SHX, DBF) Ø¨Ø§ÛŒØ¯ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ø´Ù†Ø¯</span>';
          }
        }
        
        fileInfo.style.display = 'block';
        document.getElementById('statusMsg').innerText = `${files.length} ÙØ§ÛŒÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯. Ø¢Ù…Ø§Ø¯Ù‡ Ù¾Ø±Ø¯Ø§Ø²Ø´.`;
      }
    }

    // ====== Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ùˆ Ø§Ú©Ø´Ù†â€ŒÙ‡Ø§ ======
    function setupButtons() {
      // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ
      document.getElementById('processBtn').addEventListener('click', processShapefile);
      document.getElementById('clearBtn').addEventListener('click', clearMap);
      document.getElementById('exportBtn').addEventListener('click', exportShapefile);
      document.getElementById('exportDrawingBtn').addEventListener('click', exportDrawing);

      // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù„Ø§ÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÙ‡
      document.getElementById('osmBtn').addEventListener('click', () => switchBase('OpenStreetMap â€” Ø®ÛŒØ§Ø¨Ø§Ù†'));
      document.getElementById('googleSatBtn').addEventListener('click', () => switchBase('Google Satellite â€” Ù…Ø§Ù‡ÙˆØ§Ø±Ù‡â€ŒØ§ÛŒ Ú¯ÙˆÚ¯Ù„'));
      document.getElementById('topoBtn').addEventListener('click', () => switchBase('ØªÙˆÙ¾ÙˆÚ¯Ø±Ø§ÙÛŒ â€” OpenTopoMap'));
      document.getElementById('cartoBtn').addEventListener('click', () => switchBase('CartoDB Voyager â€” Ù…Ù„Ø§ÛŒÙ…'));

      // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§
      document.getElementById('measureBtn').addEventListener('click', toggleMeasurement);
      document.getElementById('drawBtn').addEventListener('click', toggleDrawing);
      document.getElementById('labelBtn').addEventListener('click', toggleLabel);
      document.getElementById('coordBtn').addEventListener('click', toggleCoordinate);
      document.getElementById('resetViewBtn').addEventListener('click', resetView);

      // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒ
      document.getElementById('measureLengthBtn').addEventListener('click', startLengthMeasurement);
      document.getElementById('measureAreaBtn').addEventListener('click', startAreaMeasurement);
      document.getElementById('clearMeasurementsBtn').addEventListener('click', clearMeasurements);

      // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ±Ø³ÛŒÙ…
      document.getElementById('drawMarkerBtn').addEventListener('click', () => startDrawing('marker'));
      document.getElementById('drawPolylineBtn').addEventListener('click', () => startDrawing('polyline'));
      document.getElementById('drawPolygonBtn').addEventListener('click', () => startDrawing('polygon'));
      document.getElementById('drawRectangleBtn').addEventListener('click', () => startDrawing('rectangle'));
      document.getElementById('drawCircleBtn').addEventListener('click', () => startDrawing('circle'));
      document.getElementById('clearDrawingsBtn').addEventListener('click', clearDrawings);

      // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù„ÛŒØ¨Ù„â€ŒÚ¯Ø°Ø§Ø±ÛŒ
      document.getElementById('applyLabelsBtn').addEventListener('click', applyLabels);
      document.getElementById('clearLabelsBtn').addEventListener('click', clearLabels);

      // ØªØ¨Ø¯ÛŒÙ„ Ù…Ø®ØªØµØ§Øª
      document.getElementById('convertToUTMBtn').addEventListener('click', convertCoordinates);

      // Ø±Ø§Ù‡Ù†Ù…Ø§
      document.getElementById('helpToggle').addEventListener('click', () => {
        document.getElementById('helpToggle').parentElement.classList.toggle('help-open');
      });
    }

    function toggleMeasurement() {
      const panel = document.getElementById('measurementPanel');
      const btn = document.getElementById('measureBtn');
      
      if (panel.style.display === 'block') {
        panel.style.display = 'none';
        btn.classList.remove('active');
        document.getElementById('measurementResult').style.display = 'none';
      } else {
        // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ù¾Ù†Ù„â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø±
        document.getElementById('drawingPanel').style.display = 'none';
        document.getElementById('labelPanel').style.display = 'none';
        document.getElementById('coordinatePanel').style.display = 'none';
        document.getElementById('drawBtn').classList.remove('active');
        document.getElementById('labelBtn').classList.remove('active');
        document.getElementById('coordBtn').classList.remove('active');
        
        panel.style.display = 'block';
        btn.classList.add('active');
      }
    }

    function toggleDrawing() {
      const panel = document.getElementById('drawingPanel');
      const btn = document.getElementById('drawBtn');
      
      if (panel.style.display === 'block') {
        panel.style.display = 'none';
        btn.classList.remove('active');
      } else {
        // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ù¾Ù†Ù„â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø±
        document.getElementById('measurementPanel').style.display = 'none';
        document.getElementById('labelPanel').style.display = 'none';
        document.getElementById('coordinatePanel').style.display = 'none';
        document.getElementById('measureBtn').classList.remove('active');
        document.getElementById('labelBtn').classList.remove('active');
        document.getElementById('coordBtn').classList.remove('active');
        
        panel.style.display = 'block';
        btn.classList.add('active');
      }
    }

    function toggleLabel() {
      const panel = document.getElementById('labelPanel');
      const btn = document.getElementById('labelBtn');
      
      if (panel.style.display === 'block') {
        panel.style.display = 'none';
        btn.classList.remove('active');
      } else {
        // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ù¾Ù†Ù„â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø±
        document.getElementById('measurementPanel').style.display = 'none';
        document.getElementById('drawingPanel').style.display = 'none';
        document.getElementById('coordinatePanel').style.display = 'none';
        document.getElementById('measureBtn').classList.remove('active');
        document.getElementById('drawBtn').classList.remove('active');
        document.getElementById('coordBtn').classList.remove('active');
        
        panel.style.display = 'block';
        btn.classList.add('active');
      }
    }

    function toggleCoordinate() {
      const panel = document.getElementById('coordinatePanel');
      const btn = document.getElementById('coordBtn');
      
      if (panel.style.display === 'block') {
        panel.style.display = 'none';
        btn.classList.remove('active');
      } else {
        // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ù¾Ù†Ù„â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø±
        document.getElementById('measurementPanel').style.display = 'none';
        document.getElementById('drawingPanel').style.display = 'none';
        document.getElementById('labelPanel').style.display = 'none';
        document.getElementById('measureBtn').classList.remove('active');
        document.getElementById('drawBtn').classList.remove('active');
        document.getElementById('labelBtn').classList.remove('active');
        
        panel.style.display = 'block';
        btn.classList.add('active');
      }
    }

    function startLengthMeasurement() {
      new L.Draw.Polyline(map, L.Draw.Polyline.prototype.options).enable();
      document.getElementById('statusMsg').innerText = 'Ø­Ø§Ù„Øª Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒ Ø·ÙˆÙ„ ÙØ¹Ø§Ù„ Ø´Ø¯. Ø®Ø·ÛŒ ØªØ±Ø³ÛŒÙ… Ú©Ù†ÛŒØ¯.';
    }

    function startAreaMeasurement() {
      new L.Draw.Polygon(map, L.Draw.Polygon.prototype.options).enable();
      document.getElementById('statusMsg').innerText = 'Ø­Ø§Ù„Øª Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒ Ù…Ø³Ø§Ø­Øª ÙØ¹Ø§Ù„ Ø´Ø¯. Ú†Ù†Ø¯Ø¶Ù„Ø¹ÛŒ ØªØ±Ø³ÛŒÙ… Ú©Ù†ÛŒØ¯.';
    }

    function clearMeasurements() {
      measureItems.clearLayers();
      document.getElementById('measurementResult').style.display = 'none';
      document.getElementById('statusMsg').innerText = 'Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒâ€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯.';
    }

    function startDrawing(type) {
      let drawTool;
      
      switch (type) {
        case 'marker':
          drawTool = new L.Draw.Marker(map);
          break;
        case 'polyline':
          drawTool = new L.Draw.Polyline(map);
          break;
        case 'polygon':
          drawTool = new L.Draw.Polygon(map);
          break;
        case 'rectangle':
          drawTool = new L.Draw.Rectangle(map);
          break;
        case 'circle':
          drawTool = new L.Draw.Circle(map);
          break;
      }
      
      if (drawTool) {
        drawTool.enable();
        document.getElementById('statusMsg').innerText = `Ø­Ø§Ù„Øª ØªØ±Ø³ÛŒÙ… ${type} ÙØ¹Ø§Ù„ Ø´Ø¯.`;
      }
    }

    function clearDrawings() {
      drawnItems.clearLayers();
      document.getElementById('statusMsg').innerText = 'ØªØ±Ø³ÛŒÙ…â€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯.';
    }

    function convertCoordinates() {
      const lat = document.getElementById('latInput').value;
      const lon = document.getElementById('lonInput').value;
      
      if (!lat || !lon) {
        alert('Ù„Ø·ÙØ§Ù‹ Ù‡Ø± Ø¯Ùˆ ÙÛŒÙ„Ø¯ Ø¹Ø±Ø¶ Ùˆ Ø·ÙˆÙ„ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯.');
        return;
      }
      
      try {
        const utm = convertToUTM(lat, lon);
        const result = document.getElementById('utmResult');
        result.innerHTML = `
          <strong>Ù…Ø®ØªØµØ§Øª UTM:</strong><br>
          Easting: ${utm.easting}<br>
          Northing: ${utm.northing}<br>
          Zone: ${utm.zone}
        `;
        result.style.display = 'block';
        document.getElementById('statusMsg').innerText = 'ØªØ¨Ø¯ÛŒÙ„ Ù…Ø®ØªØµØ§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.';
      } catch (error) {
        alert(error.message);
      }
    }

    function resetView() {
      if (geoLayer) {
        try {
          map.fitBounds(geoLayer.getBounds(), {padding:[20,20]});
        } catch (e) {
          map.setView(KHORRAMABAD, 12);
        }
      } else {
        map.setView(KHORRAMABAD, 12);
      }
      document.getElementById('statusMsg').innerText = 'Ù†Ù…Ø§ÛŒ Ù†Ù‚Ø´Ù‡ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø´Ø¯.';
    }

    // ====== Ù…Ø¯ÛŒØ±ÛŒØª Ù†Ù…Ø§ÛŒØ´ ØªÙ…Ø§Ù… ØµÙØ­Ù‡ ======
    function setupFullscreen() {
      const fullscreenBtn = document.getElementById('fullscreenBtn');
      
      fullscreenBtn.addEventListener('click', toggleFullscreen);
      
      document.addEventListener('fullscreenchange', handleFullscreenChange);
      document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
      document.addEventListener('mozfullscreenchange', handleFullscreenChange);
      document.addEventListener('MSFullscreenChange', handleFullscreenChange);
    }
    
    function toggleFullscreen() {
      if (!isFullscreen) {
        enterFullscreen();
      } else {
        exitFullscreen();
      }
    }
    
    function enterFullscreen() {
      const element = document.documentElement;
      
      if (element.requestFullscreen) {
        element.requestFullscreen();
      } else if (element.webkitRequestFullscreen) {
        element.webkitRequestFullscreen();
      } else if (element.mozRequestFullScreen) {
        element.mozRequestFullScreen();
      } else if (element.msRequestFullscreen) {
        element.msRequestFullscreen();
      }
      
      document.body.classList.add('fullscreen');
      isFullscreen = true;
      updateFullscreenButton();
      
      setTimeout(() => {
        map.invalidateSize();
        if (geoLayer) {
          try {
            map.fitBounds(geoLayer.getBounds(), {padding:[20,20]});
          } catch (e) {}
        }
      }, 300);
    }
    
    function exitFullscreen() {
      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
      } else if (document.mozCancelFullScreen) {
        document.mozCancelFullScreen();
      } else if (document.msExitFullscreen) {
        document.msExitFullscreen();
      }
      
      document.body.classList.remove('fullscreen');
      isFullscreen = false;
      updateFullscreenButton();
      
      setTimeout(() => {
        map.invalidateSize();
      }, 300);
    }
    
    function handleFullscreenChange() {
      isFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement || 
                        document.mozFullScreenElement || document.msFullscreenElement);
      
      if (!isFullscreen) {
        document.body.classList.remove('fullscreen');
      }
      
      updateFullscreenButton();
      
      setTimeout(() => {
        map.invalidateSize();
      }, 300);
    }
    
    function updateFullscreenButton() {
      const icon = document.querySelector('#fullscreenBtn i');
      const text = document.querySelector('#fullscreenBtn span');
      
      if (isFullscreen) {
        icon.className = 'fas fa-compress';
        text.textContent = 'Ø®Ø±ÙˆØ¬ Ø§Ø² ØªÙ…Ø§Ù… ØµÙØ­Ù‡';
      } else {
        icon.className = 'fas fa-expand';
        text.textContent = 'ØªÙ…Ø§Ù… ØµÙØ­Ù‡';
      }
    }

    function switchBase(name) {
      const layer = baseLayers[name];
      if (!layer) return;
      Object.values(baseLayers).forEach(l => map.removeLayer(l));
      layer.addTo(map);
      document.getElementById('statusMsg').innerText = `Ù„Ø§ÛŒÙ‡ Ù¾Ø§ÛŒÙ‡ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯: ${name}`;
    }

    function showLoading() { 
      document.getElementById('loadingOverlay').style.display = 'flex'; 
    }
    
    function hideLoading() { 
      document.getElementById('loadingOverlay').style.display = 'none'; 
    }

    // ====== Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ§ÛŒÙ„ shapefile ======
    async function processShapefile() {
      const fileInput = document.getElementById('fileInput');
      if (!fileInput || fileInput.files.length === 0) {
        alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ shapefile (ZIP) ÛŒØ§ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ SHP/SHX/DBF Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.');
        return;
      }

      showLoading();
      document.getElementById('statusMsg').innerText = 'Ø¯Ø± Ø­Ø§Ù„ Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ UTF-8...';

      try {
        let geojson;
        if (fileInput.files.length === 1 && fileInput.files[0].name.toLowerCase().endsWith('.zip')) {
          const arrayBuffer = await fileInput.files[0].arrayBuffer();
          geojson = await shp(arrayBuffer);
        } else {
          const zip = new JSZip();
          for (let f of fileInput.files) {
            const content = await f.arrayBuffer();
            zip.file(f.name, content);
          }
          const contentArrayBuffer = await zip.generateAsync({ type: "arraybuffer" });
          geojson = await shp(contentArrayBuffer);
        }
        
        // Ø§ØµÙ„Ø§Ø­ encoding Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ØµØ­ÛŒØ­ ÙØ§Ø±Ø³ÛŒ Ø¨Ø§ UTF-8
        geojson = fixUTF8Encoding(geojson);
        onGeoJSONLoaded(geojson);
        document.getElementById('statusMsg').innerText = 'Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯. (UTF-8)';
      } catch (err) {
        console.error(err);
        alert('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ§ÛŒÙ„: ' + (err.message || err));
        document.getElementById('statusMsg').innerText = 'Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ§ÛŒÙ„.';
      } finally {
        hideLoading();
      }
    }

    // ====== Ø§ØµÙ„Ø§Ø­ encoding UTF-8 ======
    function fixUTF8Encoding(geojson) {
      if (!geojson.features) return geojson;
      
      const fixedGeoJSON = JSON.parse(JSON.stringify(geojson));
      
      fixedGeoJSON.features.forEach(feature => {
        if (feature.properties) {
          Object.keys(feature.properties).forEach(key => {
            let value = feature.properties[key];
            if (typeof value === 'string') {
              // Ø§ØµÙ„Ø§Ø­ encoding Ø¨Ø§ UTF-8
              value = decodeUTF8Text(value);
              feature.properties[key] = value;
            }
          });
        }
      });
      
      return fixedGeoJSON;
    }

    function onGeoJSONLoaded(geojson) {
      let finalGeoJSON = null;
      if (geojson.type === 'FeatureCollection') {
        finalGeoJSON = geojson;
      } else if (geojson.features) {
        finalGeoJSON = geojson;
      } else {
        const features = [];
        for (const k of Object.keys(geojson)) {
          const val = geojson[k];
          if (val && val.type === 'FeatureCollection' && val.features) features.push(...val.features);
        }
        finalGeoJSON = { type: 'FeatureCollection', features };
      }

      if (!finalGeoJSON || !finalGeoJSON.features || finalGeoJSON.features.length === 0) {
        alert('Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯ ÛŒØ§ ÙØ±Ù…Øª Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯.');
        return;
      }

      lastGeoJSON = JSON.parse(JSON.stringify(finalGeoJSON));
      showDataOnMap(lastGeoJSON);
      showAttributes(lastGeoJSON);
      populateLabelFields(lastGeoJSON); // Ù¾Ø± Ú©Ø±Ø¯Ù† Ù„ÛŒØ³Øª ÙÛŒÙ„Ø¯Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ù„ÛŒØ¨Ù„â€ŒÚ¯Ø°Ø§Ø±ÛŒ
    }

    function showDataOnMap(geojson) {
      if (geoLayer) map.removeLayer(geoLayer);

      geoLayer = L.geoJSON(geojson, {
        pointToLayer: (feature, latlng) => L.circleMarker(latlng, {
          radius: 6,
          fillColor: '#f59e0b',
          color: '#071028',
          weight: 2,
          fillOpacity: 0.9
        }),
        style: (feat) => ({
          color: '#2563eb',
          weight: 2,
          opacity: 0.9,
          fillOpacity: 0.4
        }),
        onEachFeature: (feature, layer) => {
          if (feature.properties) {
            let props = Object.entries(feature.properties)
              .map(([k,v]) => {
                const displayValue = typeof v === 'string' ? decodeUTF8Text(v) : v;
                return `<tr><td style="font-weight:700;" class="persian-text utf8-text">${escapeHtml(k)}</td><td class="persian-text utf8-text">${escapeHtml(String(displayValue))}</td></tr>`;
              }).join('');
            layer.bindPopup(`<div style="max-height:220px; overflow:auto; direction: rtl;" class="utf8-text"><table>${props}</table></div>`);
          }
        }
      }).addTo(map);

      try {
        map.fitBounds(geoLayer.getBounds(), {padding:[20,20]});
      } catch (e) {
        map.setView(KHORRAMABAD, 12);
      }
    }

    function showAttributes(geojson) {
      const container = document.getElementById('attributes');
      container.innerHTML = '';
      
      if (!geojson.features || geojson.features.length === 0) {
        container.innerHTML = '<p>Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>'; 
        return;
      }

      const keys = Object.keys(geojson.features[0].properties || {});
      
      if (keys.length === 0) {
        container.innerHTML = '<p>ÙˆÛŒÚ˜Ú¯ÛŒâ€Œ (Attribute) ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>'; 
        return;
      }

      let html = `
        <div style="margin-bottom: 10px; color: #94a3b8; font-size: 0.9rem;">
          <i class="fas fa-info-circle"></i> ØªØ¹Ø¯Ø§Ø¯ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§: ${geojson.features.length} | ØªØ¹Ø¯Ø§Ø¯ ÙÛŒÙ„Ø¯Ù‡Ø§: ${keys.length}
        </div>
        <div style="overflow:auto;">
          <table class="utf8-text">
            <thead>
              <tr>${keys.map(k => `<th class="persian-text utf8-text">${escapeHtml(decodeUTF8Text(k))}</th>`).join('')}</tr>
            </thead>
            <tbody>
      `;
      
      geojson.features.slice(0,500).forEach(f => {
        html += '<tr>' + keys.map(k => {
          const value = f.properties[k];
          const displayValue = typeof value === 'string' ? decodeUTF8Text(value) : value;
          return `<td class="persian-text utf8-text">${escapeHtml(String(displayValue ?? ""))}</td>`;
        }).join('') + '</tr>';
      });
      
      html += '</tbody></table></div>';
      
      if (geojson.features.length > 500) {
        html += `<div style="margin-top: 10px; color: #f59e0b; font-size: 0.9rem;">
          <i class="fas fa-exclamation-triangle"></i> ÙÙ‚Ø· 500 Ø±Ú©ÙˆØ±Ø¯ Ø§ÙˆÙ„ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯. (Ø§Ø² ${geojson.features.length} Ø±Ú©ÙˆØ±Ø¯)
        </div>`;
      }
      
      container.innerHTML = html;
    }

    function clearMap() {
      if (geoLayer) {
        map.removeLayer(geoLayer);
        geoLayer = null;
      }
      lastGeoJSON = null;
      clearLabels();
      document.getElementById('attributes').innerHTML = 'Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ù„Ø·ÙØ§Ù‹ ÛŒÚ© ÙØ§ÛŒÙ„ Shapefile Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯.';
      document.getElementById('statusMsg').innerText = 'Ù†Ù‚Ø´Ù‡ Ù¾Ø§Ú© Ø´Ø¯.';
      document.getElementById('fileInfo').style.display = 'none';
      document.getElementById('fileInput').value = '';
      document.getElementById('labelFieldSelect').innerHTML = '<option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ ÙÛŒÙ„Ø¯ --</option>';
    }

    function exportShapefile() {
      if (!lastGeoJSON) {
        alert('Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒâ€ŒÚ¯ÛŒØ±ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª. Ø§Ø¨ØªØ¯Ø§ ÙØ§ÛŒÙ„ Ø±Ø§ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ú©Ù†ÛŒØ¯.');
        return;
      }

      const toExport = JSON.parse(JSON.stringify(lastGeoJSON));
      toExport.features.forEach(f => {
        if (!f.properties) f.properties = {};
        f.properties._designer = 'Ø§Ú©Ø¨Ø± ÙØªØ­ÛŒâ€ŒÙ¾ÙˆØ±';
        f.properties._export_date = new Date().toISOString().split('T')[0];
      });

      document.getElementById('statusMsg').innerText = 'Ø¯Ø±Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø®Ø±ÙˆØ¬ÛŒ...';
      showLoading();

      try {
        const zipContent = shpwrite.zip(toExport);

        let blobPromise;

        if (zipContent instanceof Blob) {
          blobPromise = Promise.resolve(zipContent);
        } else if (zipContent instanceof Uint8Array || zipContent instanceof ArrayBuffer) {
          const arr = zipContent instanceof ArrayBuffer ? new Uint8Array(zipContent) : zipContent;
          blobPromise = Promise.resolve(new Blob([arr], {type: 'application/zip'}));
        } else if (zipContent && typeof zipContent.generateAsync === 'function') {
          blobPromise = zipContent.generateAsync({type:'blob'});
        } else {
          const data = typeof zipContent === 'string' ? zipContent : JSON.stringify(zipContent);
          blobPromise = Promise.resolve(new Blob([data], {type:'application/zip'}));
        }

        blobPromise.then(blob => {
          const now = new Date();
          const stamp = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}_${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}`;
          const filename = `export_shapefile_${stamp}.zip`;
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
          document.getElementById('statusMsg').innerText = `Ø®Ø±ÙˆØ¬ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯: ${filename}`;
        }).catch(e => {
          console.error(e);
          alert('Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ ÙØ§ÛŒÙ„ ZIP Ø®Ø±ÙˆØ¬ÛŒ: ' + e);
          document.getElementById('statusMsg').innerText = 'Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ø®Ø±ÙˆØ¬ÛŒ.';
        }).finally(() => hideLoading());

      } catch (err) {
        console.error(err);
        hideLoading();
        alert('Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ø®Ø±ÙˆØ¬ÛŒ shapefile: ' + (err.message||err));
        document.getElementById('statusMsg').innerText = 'Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ø®Ø±ÙˆØ¬ÛŒ.';
      }
    }

    function exportDrawing() {
      if (drawnItems.getLayers().length === 0) {
        alert('Ù‡ÛŒÚ† ØªØ±Ø³ÛŒÙ…ÛŒ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.');
        return;
      }

      document.getElementById('statusMsg').innerText = 'Ø¯Ø±Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ ØªØ±Ø³ÛŒÙ…â€ŒÙ‡Ø§...';
      showLoading();

      try {
        const geojson = drawnItems.toGeoJSON();
        
        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´ÙØ±Ø¶
        geojson.features.forEach((feature, index) => {
          if (!feature.properties) feature.properties = {};
          feature.properties.id = index + 1;
          feature.properties.type = feature.geometry.type;
          feature.properties._designer = 'Ø§Ú©Ø¨Ø± ÙØªØ­ÛŒâ€ŒÙ¾ÙˆØ±';
          feature.properties._created = new Date().toISOString();
        });

        const zipContent = shpwrite.zip(geojson);

        let blobPromise;

        if (zipContent instanceof Blob) {
          blobPromise = Promise.resolve(zipContent);
        } else if (zipContent instanceof Uint8Array || zipContent instanceof ArrayBuffer) {
          const arr = zipContent instanceof ArrayBuffer ? new Uint8Array(zipContent) : zipContent;
          blobPromise = Promise.resolve(new Blob([arr], {type: 'application/zip'}));
        } else if (zipContent && typeof zipContent.generateAsync === 'function') {
          blobPromise = zipContent.generateAsync({type:'blob'});
        } else {
          const data = typeof zipContent === 'string' ? zipContent : JSON.stringify(zipContent);
          blobPromise = Promise.resolve(new Blob([data], {type:'application/zip'}));
        }

        blobPromise.then(blob => {
          const now = new Date();
          const stamp = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}_${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}`;
          const filename = `drawings_${stamp}.zip`;
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
          document.getElementById('statusMsg').innerText = `ØªØ±Ø³ÛŒÙ…â€ŒÙ‡Ø§ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯: ${filename}`;
        }).catch(e => {
          console.error(e);
          alert('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ ØªØ±Ø³ÛŒÙ…â€ŒÙ‡Ø§: ' + e);
          document.getElementById('statusMsg').innerText = 'Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ.';
        }).finally(() => hideLoading());

      } catch (err) {
        console.error(err);
        hideLoading();
        alert('Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ ÙØ§ÛŒÙ„ ØªØ±Ø³ÛŒÙ…â€ŒÙ‡Ø§: ' + (err.message||err));
        document.getElementById('statusMsg').innerText = 'Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ.';
      }
    }

    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      return String(text)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;');
    }

    // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
    window.onload = initMap;
  </script>
</body>
</html>